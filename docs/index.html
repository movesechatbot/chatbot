<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Chatbot FAQ – Movese</title>
<style>
  body{font-family:Arial,sans-serif;background:#333;display:flex;align-items:center;flex-direction:column;width:100%;min-height:100dvh;padding:40px;overflow-x:hidden}
  h2{color:#fff}
  #chat{width:100%;max-width:420px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 0 10px #ccc}
  #pergunta{width:97%}
  .mensagem{margin:10px 0}
  .user{text-align:right;color:#2a7ae2}
  .bot{text-align:left;color:#222}
  input,button{padding:10px;margin-top:10px;width:100%;border-radius:5px;border:1px solid #ccc}
  button{background:#2a7ae2;color:#fff;border:none;cursor:pointer}
  a{margin:16px;color:#eee;text-decoration:none;font-size:1.1rem}
  #mensagens{max-height:50vh;overflow-y:auto}
  .muted{color:#999;font-size:.9rem;text-align:center}
  .meta{font-size:.85rem;color:#666;margin-top:4px}
  .badge{display:inline-block;padding:2px 6px;border-radius:4px;background:#eee;margin-right:6px}
  .badge.local{background:#d7ffd9}
  .badge.chatgpt_ctx{background:#fff3c4}
  .badge.chatgpt_open{background:#ffd7d7}
  .bar{height:6px;background:#eee;border-radius:4px;overflow:hidden;margin-top:6px}
  .bar>span{display:block;height:100%;background:#2a7ae2;width:0%}
  .thinking{opacity:.7;font-style:italic}
</style>
</head>
<body>
  <h2>CHATBOT I.A PERSONALIZADO - Movese</h2>
  <div id="chat">
    <div id="mensagens"></div>
    <input type="text" id="pergunta" placeholder="Digite sua pergunta..." />
    <button id="btnEnviar">Enviar</button>
    <div class="muted">dica: pergunte “quais cidades vocês atendem?”</div>
  </div>

<script>
  // ======= CONFIG =======
  const API_BASE = "http://localhost:10000"; // troque p/ localhost no dev
  const ENDPOINT = `${API_BASE}/chat`;
  const TIMEOUT_MS = 12000;

  // ======= UI =======
  const mensagensEl = document.getElementById('mensagens');
  const input = document.getElementById('pergunta');
  const btn = document.getElementById('btnEnviar');

  function adicionarMensagem(texto, classe, meta) {
    const wrap = document.createElement('div');
    wrap.className = `mensagem ${classe}`;
    const msg = document.createElement('div');
    msg.textContent = texto;
    wrap.appendChild(msg);

    if (meta) {
      const m = document.createElement('div');
      m.className = 'meta';
      const b = document.createElement('span');
      b.className = `badge ${meta.source || ''}`;
      b.textContent = meta.source || 'desconhecido';
      m.appendChild(b);

      if (typeof meta.similaridade === 'number') {
        const s = document.createElement('span');
        s.textContent = `sim: ${meta.similaridade.toFixed(3)}`;
        m.appendChild(s);

        const bar = document.createElement('div'); bar.className = 'bar';
        const fill = document.createElement('span'); fill.style.width = Math.max(0, Math.min(1, meta.similaridade))*100 + '%';
        bar.appendChild(fill); m.appendChild(bar);
      }
      wrap.appendChild(m);
    }

    mensagensEl.appendChild(wrap);
    mensagensEl.scrollTop = mensagensEl.scrollHeight;
    return wrap;
  }

  function setLoading(loading) {
    btn.disabled = loading;
    input.disabled = loading;
  }

  async function enviarPergunta() {
    const pergunta = input.value.trim();
    if (!pergunta) return;

    adicionarMensagem(pergunta, 'user');
    input.value = '';

    const thinking = adicionarMensagem('ia está pensando...', 'bot thinking');
    setLoading(true);

    const ac = new AbortController();
    const t = setTimeout(() => ac.abort(), TIMEOUT_MS);

    try {
      const resp = await fetch(ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ pergunta }),
        signal: ac.signal
      });
      clearTimeout(t);

      const ok = resp.ok;
      let json = {};
      try { json = await resp.json(); } catch {}

      thinking.remove();
      if (!ok) throw new Error(`HTTP ${resp.status} ${JSON.stringify(json)}`);

      adicionarMensagem(json.resposta || 'sem resposta.', 'bot', {
        source: json.source || 'local',
        similaridade: typeof json.similaridade === 'number' ? json.similaridade : undefined
      });

    } catch (err) {
      clearTimeout(t);
      thinking.remove();
      const msg = err.name === 'AbortError' ? 'timeout: servidor demorou a responder.' : 'erro ao contatar a api.';
      adicionarMensagem(msg, 'bot');
      console.error('[front] erro:', err);
    } finally {
      setLoading(false);
      input.focus();
    }
  }

  btn.addEventListener('click', enviarPergunta);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); enviarPergunta(); }
  });
</script>
</body>
</html>
